# 미러 모드 제거 후 네트워크 설정 수정 보고서

**일시**: 2026-01-06  
**문제**: 미러 모드 제거로 WSL2 네트워크 구조 변경, 프론트엔드가 백엔드에 연결 불가

---

## 🔴 문제 원인

### 미러 모드 제거의 영향

1. **네트워크 구조 변경**:
   - 미러 모드 활성화 시: Windows 호스트 네트워크를 미러링
   - 미러 모드 비활성화 시: 기본 NAT 모드로 전환

2. **IP 주소 변경**:
   - 이전 (미러 모드): `10.0.0.100` (추정)
   - 현재 (NAT 모드): `10.0.0.110` (secondary), `172.19.242.230` (primary NAT)

3. **프론트엔드 연결 실패**:
   - 프론트엔드가 하드코딩된 `10.0.0.100`으로 백엔드 접근 시도
   - 해당 IP가 더 이상 유효하지 않아 연결 실패

---

## ✅ 해결 조치

### 1. 프론트엔드 Middleware 수정

**파일**: `frontend/middleware.ts`

**변경 사항**:
- `getBackendHost()` 기본값: `10.0.0.100` → `10.0.0.110`
- `getAgentHost()` 기본값: `10.0.0.100` → `10.0.0.110`
- 디버그 로그 기본값: `10.0.0.100` → `10.0.0.110`

### 2. VNCViewer 컴포넌트 수정

**파일**: `frontend/components/VNCViewer.tsx`

**변경 사항**:
- Fallback WebSocket URL: `ws://10.0.0.100:18443` → `ws://10.0.0.110:18443`
- Default WebSocket URL: `ws://10.0.0.100:18443` → `ws://10.0.0.110:18443`
- 주석 업데이트: 미러 모드 제거 관련 설명 추가

---

## 📋 현재 네트워크 상태

### WSL2 네트워크 인터페이스

```
eth0:
  - Primary (NAT): 172.19.242.230/20
  - Secondary: 10.0.0.110/24
```

### 백엔드 서비스

- **포트**: `18443`
- **바인딩**: `0.0.0.0:18443` (모든 인터페이스)
- **접근 가능한 주소**:
  - `localhost:18443` ✅
  - `172.19.242.230:18443` ✅
  - `10.0.0.110:18443` ✅

### 프론트엔드 설정

- **기본 백엔드 호스트**: `10.0.0.110` (수정 완료)
- **기본 에이전트 호스트**: `10.0.0.110` (수정 완료)
- **VNC WebSocket**: `ws://10.0.0.110:18443` (수정 완료)

---

## 🔍 검증 결과

### 백엔드 Health Check

```bash
$ curl http://10.0.0.110:18443/api/health
{"db":"connected","libvirt":"connected","status":"ok","time":"2026-01-06T19:55:40+09:00"}
```

✅ **성공**: 백엔드가 `10.0.0.110:18443`에서 정상 응답

---

## ⚠️ 주의사항

### 1. 환경 변수 우선순위

프론트엔드는 다음 순서로 백엔드 호스트를 결정합니다:

1. `BACKEND_HOST` 환경 변수
2. `NEXT_PUBLIC_BACKEND_HOST` 환경 변수
3. 기본값: `10.0.0.110`

**권장**: 프로덕션 환경에서는 환경 변수로 명시적으로 설정

### 2. 미러 모드 재활성화 시

만약 미러 모드를 다시 활성화한다면:

1. `.wslconfig`에서 `networkingMode=mirrored` 주석 해제
2. Windows에서 `wsl --shutdown` 실행
3. WSL2 재시작
4. WSL2 IP 확인 후 프론트엔드 설정 업데이트

### 3. 네트워크 구조 변경 시

WSL2 IP가 변경되면 다음 파일들을 업데이트해야 합니다:

- `frontend/middleware.ts` (기본값)
- `frontend/components/VNCViewer.tsx` (fallback URL)
- 환경 변수 파일 (`.env.local`, `.env`)

---

## 📝 다음 단계

1. ✅ 프론트엔드 IP 주소 수정 완료
2. ⏳ 프론트엔드 재시작 (변경사항 적용)
3. ⏳ 연결 테스트
4. ⏳ 기능 테스트 (API 호출, VNC 연결 등)

---

## 🔗 관련 파일

- `frontend/middleware.ts` - API 프록시 설정
- `frontend/components/VNCViewer.tsx` - VNC WebSocket 연결
- `/mnt/c/Users/darc0/.wslconfig` - WSL2 설정 (미러 모드 비활성화됨)


