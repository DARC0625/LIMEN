name: Frontend Auto Deploy

on:
  push:
    branches: [main]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-auto-deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  # 1. ìžë™ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  quality-check:
    name: Code Quality Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Run ESLint
        working-directory: ./frontend
        run: npm run lint
        continue-on-error: false
      
      - name: Check formatting
        working-directory: ./frontend
        run: |
          npm run format:check || (echo "Code is not formatted. Run 'npm run format' in frontend directory" && exit 1)
        continue-on-error: false
      
      - name: TypeScript type check
        working-directory: ./frontend
        run: npx tsc --noEmit
      
      - name: Bundle size analysis
        working-directory: ./frontend
        run: |
          npm run build:analyze:turbo || true
          echo "Bundle analysis completed"
      
      - name: Upload quality report
        uses: actions/upload-artifact@v4
        with:
          name: quality-report
          path: frontend/.next/analyze/
          if-no-files-found: ignore
          retention-days: 30

  # 2. ìžë™ ë³´ì•ˆ ìŠ¤ìº”
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Run npm audit
        working-directory: ./frontend
        run: |
          npm audit --audit-level=moderate || true
          npm audit --json > audit-report.json || true
        continue-on-error: true
      
      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: frontend/audit-report.json
          if-no-files-found: ignore
          retention-days: 90
      
      - name: Check for known vulnerabilities
        working-directory: ./frontend
        run: |
          if npm audit --audit-level=high; then
            echo "âš ï¸ High severity vulnerabilities found!"
            exit 1
          fi

  # 3. ìžë™ ë¹Œë“œ ë° ê²€ì¦
  build:
    name: Build & Verify
    runs-on: ubuntu-latest
    needs: [quality-check, security-scan]
    timeout-minutes: 20
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Build application
        working-directory: ./frontend
        run: npm run build:verify
        env:
          NODE_ENV: production
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL || 'http://localhost:8000' }}
      
      - name: Verify build artifacts
        working-directory: ./frontend
        run: |
          if [ ! -d ".next" ]; then
            echo "âŒ Build directory not found!"
            exit 1
          fi
          if [ ! -d ".next/static" ]; then
            echo "âŒ Static files not found!"
            exit 1
          fi
          echo "âœ… Build verification passed"
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ github.sha }}
          path: |
            frontend/.next
            frontend/package.json
            frontend/package-lock.json
          retention-days: 7
          compression-level: 6

  # 4. ìžë™ ë°°í¬ (SSH)
  deploy:
    name: Auto Deploy
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 30
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ secrets.DEPLOYMENT_URL || 'https://limen.local' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-${{ github.sha }}
          path: frontend/
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to server
        run: |
          ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
            set -e
            echo "ðŸš€ Starting deployment..."
            
            # ë°±ì—… í˜„ìž¬ ë²„ì „
            if [ -d "/home/darc/LIMEN/frontend/.next" ]; then
              echo "ðŸ“¦ Creating backup..."
              tar -czf /home/darc/LIMEN/frontend/.next.backup.$(date +%Y%m%d_%H%M%S).tar.gz -C /home/darc/LIMEN/frontend .next || true
            fi
            
            # ìƒˆ ë²„ì „ ì¤€ë¹„
            cd /home/darc/LIMEN/frontend
            git pull origin main || true
            
            # PM2ë¡œ ìž¬ì‹œìž‘
            echo "ðŸ”„ Restarting application..."
            pm2 restart limen-frontend || pm2 start npm --name "limen-frontend" -- start
            
            echo "âœ… Deployment completed!"
          EOF
      
      - name: Health check
        run: |
          sleep 10
          for i in {1..5}; do
            if curl -f ${{ secrets.DEPLOYMENT_URL || 'http://localhost:9444' }}/api/health; then
              echo "âœ… Health check passed"
              exit 0
            fi
            echo "â³ Waiting for service... ($i/5)"
            sleep 5
          done
          echo "âŒ Health check failed"
          exit 1
      
      - name: Rollback on failure
        if: failure()
        run: |
          ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
            echo "ðŸ”„ Rolling back..."
            cd /home/darc/LIMEN/frontend
            git reset --hard HEAD~1 || true
            pm2 restart limen-frontend || true
            echo "âœ… Rollback completed"
          EOF

  # 5. ìžë™ ì•Œë¦¼
  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    timeout-minutes: 5
    
    steps:
      - name: Notify success
        if: success()
        run: |
          echo "âœ… Frontend deployment successful!"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo "Message: ${{ github.event.head_commit.message }}"
          # ì—¬ê¸°ì— Slack, Discord, Email ë“± ì•Œë¦¼ ì¶”ê°€ ê°€ëŠ¥
      
      - name: Notify failure
        if: failure()
        run: |
          echo "âŒ Frontend deployment failed!"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo "Check logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          # ì—¬ê¸°ì— Slack, Discord, Email ë“± ì•Œë¦¼ ì¶”ê°€ ê°€ëŠ¥

