name: Frontend Auto Deploy

on:
  push:
    branches: [main]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-auto-deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  # 1. ìë™ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  quality-check:
    name: Code Quality Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Run ESLint
        working-directory: ./frontend
        run: npm run lint
        continue-on-error: false
      
      - name: Check formatting
        working-directory: ./frontend
        run: |
          npm run format:check || (echo "Code is not formatted. Run 'npm run format' in frontend directory" && exit 1)
        continue-on-error: false
      
      - name: TypeScript type check
        working-directory: ./frontend
        run: npx tsc --noEmit
      
      - name: Bundle size analysis
        working-directory: ./frontend
        run: |
          npm run build:analyze:turbo || true
          echo "Bundle analysis completed"
      
      - name: Upload quality report
        uses: actions/upload-artifact@v4
        with:
          name: quality-report
          path: frontend/.next/analyze/
          if-no-files-found: ignore
          retention-days: 30

  # 2. ìë™ ë³´ì•ˆ ìŠ¤ìº”
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Run npm audit
        working-directory: ./frontend
        run: |
          npm audit --audit-level=moderate || true
          npm audit --json > audit-report.json || true
        continue-on-error: true
      
      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: frontend/audit-report.json
          if-no-files-found: ignore
          retention-days: 90
      
      - name: Check for known vulnerabilities
        working-directory: ./frontend
        run: |
          if npm audit --audit-level=high; then
            echo "âš ï¸ High severity vulnerabilities found!"
            exit 1
          fi

  # 3. ìë™ ë¹Œë“œ ë° ê²€ì¦
  build:
    name: Build & Verify
    runs-on: ubuntu-latest
    needs: [quality-check, security-scan]
    timeout-minutes: 20
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Build application
        working-directory: ./frontend
        run: npm run build:verify
        env:
          NODE_ENV: production
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL || 'http://localhost:8000' }}
      
      - name: Verify build artifacts
        working-directory: ./frontend
        run: |
          if [ ! -d ".next" ]; then
            echo "âŒ Build directory not found!"
            exit 1
          fi
          if [ ! -d ".next/static" ]; then
            echo "âŒ Static files not found!"
            exit 1
          fi
          echo "âœ… Build verification passed"
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ github.sha }}
          path: |
            frontend/.next
            frontend/package.json
            frontend/package-lock.json
          retention-days: 7
          compression-level: 6

  # 4. ìë™ ë°°í¬ (SSH)
  deploy:
    name: Auto Deploy
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 30
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ secrets.DEPLOYMENT_URL || 'https://limen.local' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-${{ github.sha }}
          path: frontend/
      
      - name: Deploy to Frontend Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.FRONTEND_HOST }}
          username: ${{ secrets.FRONTEND_USER }}
          key: ${{ secrets.FRONTEND_SSH_KEY }}
          port: ${{ secrets.FRONTEND_SSH_PORT || 22 }}
          script: |
            set -e
            echo "ğŸš€ Starting deployment..."
            
            # LIMEN ë””ë ‰í† ë¦¬ í™•ì¸
            if [ ! -d "/home/darc/LIMEN" ]; then
              echo "âŒ ì˜¤ë¥˜: /home/darc/LIMEN ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
              exit 1
            fi
            cd /home/darc/LIMEN || exit 1
            
            # ë°±ì—… í˜„ì¬ ë²„ì „
            if [ -d "frontend/.next" ]; then
              echo "ğŸ“¦ Creating backup..."
              tar -czf frontend/.next.backup.$(date +%Y%m%d_%H%M%S).tar.gz -C frontend .next || true
            fi
            
            # Git pull (ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°)
            echo "â¬‡ï¸  ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
            git fetch origin || {
              echo "âš ï¸  git fetch ì‹¤íŒ¨, ê³„ì† ì§„í–‰..."
            }
            
            # í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œ ë™ê¸°í™”
            echo "ğŸ“¦ í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œ ë™ê¸°í™” ì¤‘..."
            git checkout origin/main -- frontend/ || {
              echo "âš ï¸  frontend/ ì²´í¬ì•„ì›ƒ ì‹¤íŒ¨, ì „ì²´ ë™ê¸°í™” ì‹œë„..."
              git reset --hard origin/main || {
                echo "âŒ git reset ì‹¤íŒ¨"
                exit 1
              }
            }
            
            # RAG ë¬¸ì„œ ë™ê¸°í™”
            echo "ğŸ“š RAG ë¬¸ì„œ ë™ê¸°í™” ì¤‘..."
            git checkout origin/main -- RAG/ || true
            
            # ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë³µì‚¬ (GitHub Actionsì—ì„œ ë¹Œë“œëœ ê²ƒ)
            echo "ğŸ“¦ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì¤€ë¹„ ì¤‘..."
            # ì‹¤ì œë¡œëŠ” GitHub Actionsì—ì„œ ë¹Œë“œëœ .nextë¥¼ ë³µì‚¬í•´ì•¼ í•˜ì§€ë§Œ,
            # ì—¬ê¸°ì„œëŠ” ì„œë²„ì—ì„œ ì§ì ‘ ë¹Œë“œí•˜ê±°ë‚˜, ì•„í‹°íŒ©íŠ¸ë¥¼ ë‹¤ìš´ë¡œë“œí•´ì•¼ í•¨
            
            # í”„ë¡ íŠ¸ì—”ë“œ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /home/darc/LIMEN/frontend || exit 1
            
            # ì˜ì¡´ì„± ì„¤ì¹˜ (í•„ìš”ì‹œ)
            if [ ! -d "node_modules" ]; then
              echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
              npm ci || npm install
            fi
            
            # ë¹Œë“œ (ì•„í‹°íŒ©íŠ¸ê°€ ì—†ëŠ” ê²½ìš°)
            if [ ! -d ".next" ]; then
              echo "ğŸ”¨ ë¹Œë“œ ì¤‘..."
              npm run build || {
                echo "âŒ ë¹Œë“œ ì‹¤íŒ¨"
                exit 1
              }
            fi
            
            # PM2ë¡œ ì¬ì‹œì‘
            echo "ğŸ”„ Restarting application..."
            if command -v pm2 &> /dev/null; then
              pm2 restart limen-frontend --update-env || pm2 start npm --name "limen-frontend" -- start || {
                echo "âŒ PM2 ì¬ì‹œì‘ ì‹¤íŒ¨"
                exit 1
              }
            else
              echo "âš ï¸  PM2ê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤"
            fi
            
            echo "âœ… Deployment completed!"
      
      - name: Health check
        run: |
          FRONTEND_URL="${{ secrets.FRONTEND_URL || 'http://10.0.0.10:9444' }}"
          echo "í—¬ìŠ¤ì²´í¬: $FRONTEND_URL"
          sleep 10
          for i in {1..5}; do
            if curl -f -s "$FRONTEND_URL" > /dev/null || curl -f -s "$FRONTEND_URL/api/health" > /dev/null; then
              echo "âœ… Health check passed"
              exit 0
            fi
            echo "â³ Waiting for service... ($i/5)"
            sleep 5
          done
          echo "âš ï¸ Health check failed (ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ ì¤‘ì´ì§€ ì•Šì„ ìˆ˜ ìˆìŒ)"
          # exit 1 ëŒ€ì‹  ê²½ê³ ë§Œ ì¶œë ¥ (ì„œë¹„ìŠ¤ê°€ ì—†ì„ ìˆ˜ë„ ìˆìŒ)
      
      - name: Rollback on failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.FRONTEND_HOST }}
          username: ${{ secrets.FRONTEND_USER }}
          key: ${{ secrets.FRONTEND_SSH_KEY }}
          port: ${{ secrets.FRONTEND_SSH_PORT || 22 }}
          script: |
            echo "ğŸ”„ Rolling back..."
            cd /home/darc/LIMEN/frontend || exit 0
            git reset --hard HEAD~1 || true
            if command -v pm2 &> /dev/null; then
              pm2 restart limen-frontend || true
            fi
            echo "âœ… Rollback completed"

  # 5. ìë™ ì•Œë¦¼
  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    timeout-minutes: 5
    
    steps:
      - name: Notify success
        if: success()
        run: |
          echo "âœ… Frontend deployment successful!"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo "Message: ${{ github.event.head_commit.message }}"
          # ì—¬ê¸°ì— Slack, Discord, Email ë“± ì•Œë¦¼ ì¶”ê°€ ê°€ëŠ¥
      
      - name: Notify failure
        if: failure()
        run: |
          echo "âŒ Frontend deployment failed!"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo "Check logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          # ì—¬ê¸°ì— Slack, Discord, Email ë“± ì•Œë¦¼ ì¶”ê°€ ê°€ëŠ¥

