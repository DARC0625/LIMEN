name: CI Backend

on:
  pull_request:
    paths:
      - "backend/**"
      - "config/**"
      - "infra/**"
      - "scripts/shared/**"
      - ".github/workflows/ci-backend.yml"
  push:
    branches: [ main ]
    paths:
      - "backend/**"
      - "config/**"
      - "infra/**"
      - "scripts/shared/**"
      - ".github/workflows/ci-backend.yml"

jobs:
  backend-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: backend/go.mod
          cache-dependency-path: backend/go.sum

      - name: Go test (fast suite, explicit package list, timeout 3m)
        working-directory: backend
        timeout-minutes: 4
        run: |
          echo "=== Running Go tests (fast suite, timeout 3m) ==="
          echo "PR용 fast suite: 비즈니스 로직 + 보안 + 입력 검증만 실행"
          echo "느린 패키지(internal/vm, scripts/**)는 nightly로 분리됨"
          echo ""
          
          set +e
          go test -v -count=1 -timeout 3m \
            ./internal/handlers \
            ./internal/router \
            ./internal/middleware \
            ./internal/validator \
            ./internal/security \
            ./internal/session \
            ./internal/auth \
            ./internal/crypto \
            ./internal/models \
            ./internal/errors \
            ./internal/config \
            ./internal/ratelimit \
            | tee test.log
          TEST_EXIT=$?
          set -e
          
          echo ""
          echo "=== Slowest Packages (from test.log) ==="
          if [ -f test.log ]; then
            # Extract package timing: "ok      package/path    0.123s"
            grep -E "^\s+(ok|FAIL)\s+\S+\s+[0-9]+\.[0-9]+s" test.log | \
              awk '{print $NF, $2}' | sort -rn | head -10 || \
            echo "Check test.log manually for package timings"
            
            echo ""
            echo "=== Module download check ==="
            grep -i "go: downloading" test.log | head -5 || echo "No slow downloads detected"
          fi
          
          exit $TEST_EXIT
