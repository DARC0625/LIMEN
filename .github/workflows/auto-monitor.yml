name: Auto Monitor

on:
  schedule:
    # ë§¤ì‹œê°„ ì‹¤í–‰
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  performance-check:
    name: Performance Monitoring
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Build and analyze
        working-directory: ./frontend
        run: |
          npm run build:analyze:turbo || npm run build
          echo "Build completed"
      
      - name: Check bundle size
        working-directory: ./frontend
        run: |
          if [ -d ".next/static/chunks" ]; then
            TOTAL_SIZE=$(du -sh .next/static/chunks | cut -f1)
            echo "ğŸ“¦ Total bundle size: $TOTAL_SIZE"
            
            # í° íŒŒì¼ ì°¾ê¸°
            find .next/static/chunks -type f -size +500k -exec ls -lh {} \; | head -10
          fi
      
      - name: Upload performance report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report-$(date +%Y%m%d-%H%M%S)
          path: frontend/.next/analyze/
          if-no-files-found: ignore
          retention-days: 30

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Check frontend health
        run: |
          FRONTEND_URL="${{ secrets.FRONTEND_URL || 'http://localhost:9444' }}"
          
          if curl -f -s "$FRONTEND_URL/api/health" > /dev/null; then
            echo "âœ… Frontend is healthy"
          else
            echo "âŒ Frontend health check failed"
            exit 1
          fi
      
      - name: Check backend health
        run: |
          BACKEND_URL="${{ secrets.BACKEND_URL || 'http://localhost:8000' }}"
          
          if curl -f -s "$BACKEND_URL/api/health" > /dev/null; then
            echo "âœ… Backend is healthy"
          else
            echo "âŒ Backend health check failed"
            exit 1
          fi
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "ğŸš¨ Health check failed!"
          echo "Time: $(date)"
          # ì•Œë¦¼ ì¶”ê°€ ê°€ëŠ¥

