name: Policy Gates (Repo-level)

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  gates:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Enforce repository policies
        shell: bash
        run: |
          set -euo pipefail
          echo "[1/6] root src/ must not exist"
          test ! -d "src" || (echo "[FATAL] root src/ must not exist" && exit 1)

          echo "[2/6] docs/ must not exist (all docs under RAG/)"
          test ! -d "docs" || (echo "[FATAL] docs/ must not exist (use RAG/)" && exit 1)

          echo "[3/6] Required folders sanity"
          test -d "frontend" || echo "[WARN] frontend/ missing"
          test -d "backend"  || echo "[WARN] backend/ missing"

          echo "[4/6] Prevent edge-only/backend-only leakage (policy-level)"
          # backend에 frontend 잔재 금지
          if [ -d "backend" ]; then
            for item in frontend package.json package-lock.json pnpm-lock.yaml .next; do
              if [ -e "backend/$item" ]; then
                echo "[FATAL] backend/ contains forbidden: $item"
                exit 1
              fi
            done
          fi
          # frontend에 backend 잔재 금지
          if [ -d "frontend" ]; then
            for item in internal cmd go.mod go.sum; do
              if [ -e "frontend/$item" ]; then
                echo "[FATAL] frontend/ contains forbidden: $item"
                exit 1
              fi
            done
          fi

          echo "[5/6] Ensure .github/workflows only contains allowed workflow files"
          # ***핵심: workflows 디렉토리만, yml/yaml만 검사***
          allowed_regex='^(policy-gates\.yml|ci-backend\.yml)$'
          bad="$(find .github/workflows -maxdepth 1 -type f \( -name '*.yml' -o -name '*.yaml' \) -printf '%f\n' \
            | grep -Ev "${allowed_regex}" || true)"
          if [ -n "$bad" ]; then
            echo "[FATAL] Found non-allowed workflow files:"
            echo "$bad"
            exit 1
          fi

          echo "[6/6] OK"
