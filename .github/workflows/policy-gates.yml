name: Policy Gates (Repo-level)

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - "backend/**"
      - "frontend/**"
      - "config/**"
      - "infra/**"
      - "scripts/shared/**"
      - ".github/workflows/**"
  push:
    branches: [ main, develop ]
    paths:
      - "backend/**"
      - "frontend/**"
      - "config/**"
      - "infra/**"
      - "scripts/shared/**"
      - ".github/workflows/**"

jobs:
  gates:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Enforce repository policies
        shell: bash
        run: |
          set -euo pipefail
          echo "[1/6] root src/ must not exist"
          test ! -d "src" || (echo "[FATAL] root src/ must not exist" && exit 1)

          echo "[2/6] docs/ must not exist (all docs under RAG/)"
          test ! -d "docs" || (echo "[FATAL] docs/ must not exist (use RAG/)" && exit 1)

          echo "[3/6] Required folders sanity"
          test -d "frontend" || echo "[WARN] frontend/ missing"
          test -d "backend"  || echo "[WARN] backend/ missing"

          echo "[4/6] Prevent edge-only/backend-only leakage (policy-level)"
          # backend에 frontend 잔재 금지
          if [ -d "backend" ]; then
            for item in frontend package.json package-lock.json pnpm-lock.yaml .next; do
              if [ -e "backend/$item" ]; then
                echo "[FATAL] backend/ contains forbidden: $item"
                exit 1
              fi
            done
          fi
          # frontend에 backend 잔재 금지
          if [ -d "frontend" ]; then
            for item in internal cmd go.mod go.sum; do
              if [ -e "frontend/$item" ]; then
                echo "[FATAL] frontend/ contains forbidden: $item"
                exit 1
              fi
            done
          fi

          echo "[5/6] Ensure .github/workflows only contains allowed workflow files"
          # ***핵심: workflows 디렉토리만, yml/yaml만 검사***
          # ✅ 패턴 허용으로 변경: 파일명 추가가 아니라 패턴 허용
          # 예: .github/workflows/*e2e*.yml 허용
          # 그래야 미래에 e2e 워크플로 늘려도 또 터지지 않는다
          # 정책은 자동화를 보호하는 장치, 발목 잡는 장치 아님
          allowed_patterns=(
            'policy-gates\.yml'
            'ci-backend\.yml'
            'ci-frontend\.yml'
            '.*e2e.*\.yml'  # e2e 포함된 모든 워크플로 허용
          )
          allowed_regex="^($(IFS='|'; echo "${allowed_patterns[*]}"))$"
          bad="$(find .github/workflows -maxdepth 1 -type f \( -name '*.yml' -o -name '*.yaml' \) -printf '%f\n' \
            | grep -Ev "${allowed_regex}" || true)"
          if [ -n "$bad" ]; then
            echo "[FATAL] Found non-allowed workflow files:"
            echo "$bad"
            exit 1
          fi

          echo "[6/6] OK"
