name: Nightly E2E (Cross-Browser + Integration)

on:
  schedule:
    # ë§¤ì¼ í•œêµ­ì‹œê°„ ì˜¤ì „ 3ì‹œ (UTC 18:00) ì‹¤í–‰
    - cron: '0 18 * * *'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      run_integration:
        description: 'Run integration E2E tests (requires secrets)'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '20'

jobs:
  # âœ… Cross-Browser Hermetic Sweep
  # PR GateëŠ” chromium-only, NightlyëŠ” 3ë¸Œë¼ìš°ì € ì „ë¶€ ì‹¤í–‰
  e2e-hermetic-cross-browser:
    name: E2E Hermetic (Cross-Browser)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        working-directory: ./frontend

    strategy:
      fail-fast: false  # í•œ ë¸Œë¼ìš°ì € ì‹¤íŒ¨í•´ë„ ë‚˜ë¨¸ì§€ ê³„ì† ì‹¤í–‰
      matrix:
        browser: [chromium, firefox, webkit]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: ./frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: Run E2E hermetic tests (${{ matrix.browser }})
        run: npm run test:e2e
        env:
          CI: true
          # âœ… NightlyëŠ” ëª¨ë“  ë¸Œë¼ìš°ì € ì‹¤í–‰ (playwright.config.tsì—ì„œ testMatchë¡œ ì „ì²´ í—ˆìš©)
          # í•˜ì§€ë§Œ ì‹¤ì œë¡œëŠ” token-refresh.spec.tsë§Œ ì‹¤í–‰ë¨ (hermetic only)

      - name: Upload Playwright report (${{ matrix.browser }})
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.browser }}
          path: frontend/playwright-report
          retention-days: 14

      - name: Upload test results (${{ matrix.browser }})
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-test-results-${{ matrix.browser }}
          path: frontend/test-results
          retention-days: 14

      - name: Upload trace (${{ matrix.browser }})
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-trace-${{ matrix.browser }}
          path: frontend/test-results
          retention-days: 14

      - name: Process test results (${{ matrix.browser }})
        if: always()
        run: |
          # âœ… step-level runì—ì„œ ì¡°ê±´ ì²´í¬ (ê·œì¹™ ì¤€ìˆ˜)
          # NightlyëŠ” merge ì°¨ë‹¨í•˜ì§€ ì•ŠìŒ - ì•„í‹°íŒ©íŠ¸ë§Œ ì €ì¥
          if [ -f "test-results/results.json" ]; then
            FAILED_COUNT=$(jq -r '.stats.failures' test-results/results.json || echo "0")
            TOTAL_COUNT=$(jq -r '.stats.total' test-results/results.json || echo "0")
            
            echo "ğŸ“Š ${{ matrix.browser }} í…ŒìŠ¤íŠ¸ ê²°ê³¼:"
            echo "  - ì´ í…ŒìŠ¤íŠ¸: $TOTAL_COUNT"
            echo "  - ì‹¤íŒ¨: $FAILED_COUNT"
            
            if [ "$FAILED_COUNT" -gt 0 ]; then
              echo "âš ï¸ ${{ matrix.browser }}ì—ì„œ $FAILED_COUNT ê°œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
              echo "ğŸ“ 48ì‹œê°„ ë‚´ ì´ìŠˆí™” í•„ìš”"
              # merge ì°¨ë‹¨í•˜ì§€ ì•ŠìŒ - ê·œì¹™ ì¤€ìˆ˜
            fi
          fi

  # âœ… Integration Sweep (ì‹¤ì„œë²„ ì˜ì¡´)
  # vm-console-e2e.spec.ts, compatibility.spec.ts
  # ì£¼ì˜: self-hosted runnerê°€ ì¤€ë¹„ë˜ë©´ ì´ jobì„ self-hostedë¡œ ì´ë™
  e2e-integration:
    name: E2E Integration (Real Server)
    runs-on: ubuntu-latest
    timeout-minutes: 60
    defaults:
      run:
        working-directory: ./frontend

    # âœ… Integrationì€ ì‹¤ì„œë²„/ê³„ì • ì˜ì¡´ì´ ìˆìœ¼ë¯€ë¡œ ì¡°ê±´ë¶€ ì‹¤í–‰
    # âŒ if: ì—ì„œ env, secrets ì§ì ‘ ë¹„êµ ê¸ˆì§€
    # âœ… step-level runì—ì„œ ì²´í¬ (ê·œì¹™ ì¤€ìˆ˜)
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: ./frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Check integration condition
        run: |
          # âœ… step-level runì—ì„œ ì¡°ê±´ ì²´í¬ (ê·œì¹™ ì¤€ìˆ˜)
          if [ "${{ github.event.inputs.run_integration }}" != "true" ]; then
            echo "Integration í…ŒìŠ¤íŠ¸ê°€ ìš”ì²­ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìŠ¤í‚µí•©ë‹ˆë‹¤."
            exit 0
          fi

      - name: Run E2E integration tests
        run: npm run test:e2e:integration
        env:
          CI: true
          ADMIN_USER: ${{ secrets.ADMIN_USER }}
          ADMIN_PASS: ${{ secrets.ADMIN_PASS }}
          BASE_URL: ${{ secrets.BASE_URL || vars.BASE_URL || 'https://staging.limen.kr' }}
          # âœ… Integrationì€ ì‹¤ì„œë²„ ì˜ì¡´ì´ë¯€ë¡œ secrets/varsì—ì„œ ê°€ì ¸ì˜´
          # secrets ì¡´ì¬ ì—¬ë¶€ëŠ” job ë‚´ë¶€ì—ì„œë§Œ ì‚¬ìš© (workflow íŒŒì‹± ë‹¨ê³„ì—ì„œëŠ” ì‚¬ìš© ì•ˆ í•¨)

      - name: Upload Playwright report (integration)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-integration
          path: frontend/playwright-report
          retention-days: 14

      - name: Upload test results (integration)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-test-results-integration
          path: frontend/test-results
          retention-days: 14

  # âœ… Cross-Browser Summary
  # ëª¨ë“  ë¸Œë¼ìš°ì € ê²°ê³¼ë¥¼ ì¢…í•©í•˜ì—¬ ë¦¬í¬íŠ¸
  e2e-summary:
    name: E2E Summary
    runs-on: ubuntu-latest
    needs: [e2e-hermetic-cross-browser]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check results
        run: |
          echo "âœ… Cross-Browser Hermetic Sweep ì™„ë£Œ"
          echo "ë¸Œë¼ìš°ì €ë³„ ê²°ê³¼ëŠ” ê° jobì—ì„œ í™•ì¸í•˜ì„¸ìš”"
          echo ""
          echo "ë‹¤ìŒ ë‹¨ê³„:"
          echo "- Self-hosted runner ì¤€ë¹„ ì‹œ integration jobì„ self-hostedë¡œ ì´ë™"
          echo "- ê¸°ê´€ë§/í”„ë¡ì‹œ ì¡°ê±´ ì¶”ê°€ ê²€ì¦"

  # âœ… ì‹¤íŒ¨ ì‹œ ì´ìŠˆ ìë™ ìƒì„± (48ì‹œê°„ ë‚´ ì´ìŠˆí™” ê·œì¹™)
  create-issue-on-failure:
    name: Create Issue on Failure
    runs-on: ubuntu-latest
    needs: [e2e-hermetic-cross-browser]
    if: failure() # e2e-hermetic-cross-browser jobì´ ì‹¤íŒ¨í•œ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create issue
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'nightly-e2e-failure'
            });
            
            // ì¤‘ë³µ ì´ìŠˆ ë°©ì§€
            const existingIssue = issues.find(issue => 
              issue.title.includes('Nightly E2E Failure')
            );
            
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[Nightly E2E] Cross-Browser í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ - ${new Date().toISOString().split('T')[0]}`,
                body: `## Nightly E2E í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ë³´ê³ 
                
                **ì‹¤í–‰ ì‹œê°„**: ${new Date().toISOString()}
                **ì›Œí¬í”Œë¡œìš°**: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
                
                ### ì‹¤íŒ¨ ë¸Œë¼ìš°ì €
                - ì•„í‹°íŒ©íŠ¸ì—ì„œ í™•ì¸ í•„ìš”
                
                ### ì¡°ì¹˜ ì‚¬í•­
                - [ ] ì•„í‹°íŒ©íŠ¸ í™•ì¸ (trace, video)
                - [ ] ì‹¤íŒ¨ ì›ì¸ ë¶„ì„
                - [ ] ìˆ˜ì • ë˜ëŠ” ì´ìŠˆ ì¶”ì 
                
                ### ê·œì¹™ ì¤€ìˆ˜
                - âœ… merge ì°¨ë‹¨í•˜ì§€ ì•ŠìŒ
                - âœ… ì•„í‹°íŒ©íŠ¸ + trace + ì˜ìƒ ì €ì¥ë¨
                - âœ… 48ì‹œê°„ ë‚´ ì´ìŠˆí™”`,
                labels: ['nightly-e2e-failure', 'bug']
              });
            }
