static_resources:
  listeners:
    # HTTP 리스너 (포트 80)
    - name: listener_http
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 80
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: ingress_http
                # access_log는 PM2가 관리하므로 제거
                # access_log:
                #   - name: envoy.access_loggers.stdout
                #     typed_config:
                #       "@type": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog
                #       log_format:
                #         json_format:
                #           request_id: "%REQ(X-REQUEST-ID)%"
                #           status: "%RESPONSE_CODE%"
                #           upstream_time: "%RESPONSE_DURATION%"
                #           user_agent: "%REQ(USER-AGENT)%"
                #           source_ip: "%DOWNSTREAM_REMOTE_ADDRESS_WITHOUT_PORT%"
                #           method: "%REQ(:METHOD)%"
                #           path: "%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%"
                #           protocol: "%PROTOCOL%"
                upgrade_configs:
                  - upgrade_type: websocket
                http_filters:
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
                route_config:
                  name: local_route
                  response_headers_to_add:
                    - header:
                        key: "Strict-Transport-Security"
                        value: "max-age=31536000; includeSubDomains"
                    - header:
                        key: "X-Content-Type-Options"
                        value: "nosniff"
                    - header:
                        key: "Referrer-Policy"
                        value: "strict-origin-when-cross-origin"
                    - header:
                        key: "X-Frame-Options"
                        value: "DENY"
                  virtual_hosts:
                    # LIMEN 서비스 (limen.kr)
                    - name: limen_frontend
                      domains: ["limen.kr", "www.limen.kr"]
                      routes:
                        # Next.js 정적 파일 프록시 (우선순위 높음)
                        - match:
                            prefix: "/_next/"
                          route:
                            cluster: limen_cluster
                            timeout: 60s
                        # VNC WebSocket 프록시 (백엔드로 직접)
                        # WebSocket 업그레이드 헤더가 있는 /vnc/ 요청만 백엔드로 프록시
                        # 일반 HTTP GET 요청은 Next.js로 전달 (VNC 페이지 렌더링)
                        # 정책: idle timeout 1시간, max connection duration 24시간
                        - match:
                            prefix: "/vnc/"
                            headers:
                              - name: "Upgrade"
                                exact_match: "websocket"
                          route:
                            cluster: backend_cluster
                            timeout: 3600s  # idle timeout: 1시간
                            max_stream_duration:
                              max_stream_duration: 86400s  # max connection duration: 24시간
                            host_rewrite_literal: 10.0.0.100
                            upgrade_configs:
                              - upgrade_type: websocket
                        # WebSocket 프록시 (백엔드로 직접)
                        # 정책: idle timeout 1시간, max connection duration 24시간
                        - match:
                            prefix: "/ws/"
                          route:
                            cluster: backend_cluster
                            timeout: 3600s  # idle timeout: 1시간
                            max_stream_duration:
                              max_stream_duration: 86400s  # max connection duration: 24시간
                            host_rewrite_literal: 10.0.0.100
                            # WebSocket upgrade 명시적 설정
                            upgrade_configs:
                              - upgrade_type: websocket
                        # API 프록시 (Next.js middleware를 통해 백엔드로)
                        # 중요: Next.js middleware가 쿠키를 제대로 처리하도록 Next.js로 전달
                        - match:
                            prefix: "/api/"
                          route:
                            cluster: limen_cluster
                            timeout: 60s
                        # Agent 프록시 (Agent로 직접)
                        - match:
                            prefix: "/agent/"
                          route:
                            cluster: agent_cluster
                            prefix_rewrite: "/"
                            host_rewrite_literal: 10.0.0.100
                        # 프론트엔드 프록시 (LIMEN Next.js - 포트 9444)
                        - match:
                            prefix: "/"
                          route:
                            cluster: limen_cluster
                            timeout: 60s
                    
                    # DARC.KR 웹사이트 (darc.kr, www.darc.kr)
                    # 정적 페이지만 제공 (API 없음)
                    - name: darc_frontend
                      domains: ["www.darc.kr", "darc.kr"]
                      routes:
                        # Next.js 정적 파일 프록시 (우선순위 높음)
                        - match:
                            prefix: "/_next/"
                          route:
                            cluster: darc_cluster
                            timeout: 60s
                        # 프론트엔드 프록시 (DARC 웹사이트 - 포트 9445)
                        - match:
                            prefix: "/"
                          route:
                            cluster: darc_cluster
                            timeout: 60s
                        # Agent 프록시 (Agent로 직접)
                        - match:
                            prefix: "/agent/"
                          route:
                            cluster: agent_cluster
                            prefix_rewrite: "/"
                            host_rewrite_literal: 10.0.0.100
                        # 프론트엔드 프록시 (DARC 웹사이트 - 포트 9445)
                        - match:
                            prefix: "/"
                          route:
                            cluster: darc_cluster
                            timeout: 60s
                    
                    # 기본 (fallback - LIMEN으로 라우팅)
                    - name: default_frontend
                      domains: ["*"]
                      routes:
                        - match:
                            prefix: "/"
                          route:
                            cluster: limen_cluster
                            timeout: 60s

    # HTTPS 리스너 (포트 443)
    - name: listener_https
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 443
      listener_filters:
        - name: envoy.filters.listener.tls_inspector
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.listener.tls_inspector.v3.TlsInspector
      filter_chains:
        # LIMEN 서비스 TLS 인증서 (limen.kr)
        - filter_chain_match:
            server_names: ["limen.kr", "www.limen.kr"]
          transport_socket:
            name: envoy.transport_sockets.tls
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext
              common_tls_context:
                tls_certificates:
                  - certificate_chain:
                      filename: "/etc/letsencrypt/live/limen.kr/fullchain.pem"
                    private_key:
                      filename: "/etc/letsencrypt/live/limen.kr/privkey.pem"
              require_client_certificate: false
          filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: ingress_https_limen
                # access_log는 PM2가 관리하므로 제거
                # access_log:
                #   - name: envoy.access_loggers.stdout
                #     typed_config:
                #       "@type": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog
                #       log_format:
                #         json_format:
                #           request_id: "%REQ(X-REQUEST-ID)%"
                #           status: "%RESPONSE_CODE%"
                #           upstream_time: "%RESPONSE_DURATION%"
                #           user_agent: "%REQ(USER-AGENT)%"
                #           source_ip: "%DOWNSTREAM_REMOTE_ADDRESS_WITHOUT_PORT%"
                #           method: "%REQ(:METHOD)%"
                #           path: "%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%"
                #           protocol: "%PROTOCOL%"
                upgrade_configs:
                  - upgrade_type: websocket
                # CORS는 백엔드에서 처리하므로 Envoy에서는 헤더를 그대로 전달
                # CORS는 백엔드에서 처리하므로 Envoy에서는 헤더를 그대로 전달
                # Envoy Router 필터는 기본적으로 백엔드 응답 헤더를 그대로 전달함
                http_filters:
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
                route_config:
                  name: local_route_https_limen
                  response_headers_to_add:
                    - header:
                        key: "Strict-Transport-Security"
                        value: "max-age=31536000; includeSubDomains"
                    - header:
                        key: "X-Content-Type-Options"
                        value: "nosniff"
                    - header:
                        key: "Referrer-Policy"
                        value: "strict-origin-when-cross-origin"
                    - header:
                        key: "X-Frame-Options"
                        value: "DENY"
                  virtual_hosts:
                    - name: limen_frontend_https
                      domains: ["limen.kr", "www.limen.kr"]
                      routes:
                        # Next.js 정적 파일 프록시 (우선순위 높음)
                        - match:
                            prefix: "/_next/"
                          route:
                            cluster: limen_cluster
                            timeout: 60s
                        # VNC WebSocket 프록시 (백엔드로 직접)
                        # WebSocket 업그레이드 헤더가 있는 /vnc/ 요청만 백엔드로 프록시
                        # 일반 HTTP GET 요청은 Next.js로 전달 (VNC 페이지 렌더링)
                        # 정책: idle timeout 1시간, max connection duration 24시간
                        - match:
                            prefix: "/vnc/"
                            headers:
                              - name: "Upgrade"
                                exact_match: "websocket"
                          route:
                            cluster: backend_cluster
                            timeout: 3600s  # idle timeout: 1시간
                            max_stream_duration:
                              max_stream_duration: 86400s  # max connection duration: 24시간
                            host_rewrite_literal: 10.0.0.100
                            upgrade_configs:
                              - upgrade_type: websocket
                        # WebSocket 프록시 (백엔드로 직접)
                        # 정책: idle timeout 1시간, max connection duration 24시간
                        - match:
                            prefix: "/ws/"
                          route:
                            cluster: backend_cluster
                            timeout: 3600s  # idle timeout: 1시간
                            max_stream_duration:
                              max_stream_duration: 86400s  # max connection duration: 24시간
                            host_rewrite_literal: 10.0.0.100
                            # WebSocket upgrade 명시적 설정
                            upgrade_configs:
                              - upgrade_type: websocket
                        # API 프록시 (Next.js middleware를 통해 백엔드로)
                        # 중요: Next.js middleware가 쿠키를 제대로 처리하도록 Next.js로 전달
                        - match:
                            prefix: "/api/"
                          route:
                            cluster: limen_cluster
                            timeout: 60s
                        # Agent 프록시 (Agent로 직접)
                        - match:
                            prefix: "/agent/"
                          route:
                            cluster: agent_cluster
                            prefix_rewrite: "/"
                            host_rewrite_literal: 10.0.0.100
                        # 프론트엔드 프록시 (LIMEN Next.js)
                        - match:
                            prefix: "/"
                          route:
                            cluster: limen_cluster
                            timeout: 60s
        
        # DARC.KR 웹사이트 TLS 인증서 (darc.kr, www.darc.kr)
        - filter_chain_match:
            server_names: ["www.darc.kr", "darc.kr"]
          transport_socket:
            name: envoy.transport_sockets.tls
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext
              common_tls_context:
                tls_certificates:
                  - certificate_chain:
                      filename: "/etc/letsencrypt/live/www.darc.kr/fullchain.pem"
                    private_key:
                      filename: "/etc/letsencrypt/live/www.darc.kr/privkey.pem"
              require_client_certificate: false
          filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: ingress_https_darc
                # access_log는 PM2가 관리하므로 제거
                # access_log:
                #   - name: envoy.access_loggers.stdout
                #     typed_config:
                #       "@type": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog
                #       log_format:
                #         json_format:
                #           request_id: "%REQ(X-REQUEST-ID)%"
                #           status: "%RESPONSE_CODE%"
                #           upstream_time: "%RESPONSE_DURATION%"
                #           user_agent: "%REQ(USER-AGENT)%"
                #           source_ip: "%DOWNSTREAM_REMOTE_ADDRESS_WITHOUT_PORT%"
                #           method: "%REQ(:METHOD)%"
                #           path: "%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%"
                #           protocol: "%PROTOCOL%"
                upgrade_configs:
                  - upgrade_type: websocket
                http_filters:
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
                route_config:
                  name: local_route_https_darc
                  response_headers_to_add:
                    - header:
                        key: "Strict-Transport-Security"
                        value: "max-age=31536000; includeSubDomains"
                    - header:
                        key: "X-Content-Type-Options"
                        value: "nosniff"
                    - header:
                        key: "Referrer-Policy"
                        value: "strict-origin-when-cross-origin"
                    - header:
                        key: "X-Frame-Options"
                        value: "DENY"
                  virtual_hosts:
                    - name: darc_frontend_https
                      domains: ["www.darc.kr", "darc.kr"]
                      routes:
                        # Next.js 정적 파일 프록시 (우선순위 높음)
                        - match:
                            prefix: "/_next/"
                          route:
                            cluster: darc_cluster
                            timeout: 60s
                        # 프론트엔드 프록시 (DARC 웹사이트 - 포트 9445)
                        # 정적 페이지만 제공 (API 없음)
                        - match:
                            prefix: "/"
                          route:
                            cluster: darc_cluster
                            timeout: 60s

  clusters:
    # LIMEN 프론트엔드 클러스터 (Next.js - 포트 9444)
    - name: limen_cluster
      connect_timeout: 5s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: limen_cluster
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: 127.0.0.1
                      port_value: 9444
      health_checks:
        - timeout: 1s
          interval: 10s
          unhealthy_threshold: 3
          healthy_threshold: 1
          http_health_check:
            path: "/api/health_proxy"
            expected_statuses:
              - start: 200
                end: 399

    # DARC.KR 웹사이트 클러스터 (포트 9445)
    - name: darc_cluster
      connect_timeout: 5s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: darc_cluster
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: 127.0.0.1
                      port_value: 9445
      health_checks:
        - timeout: 1s
          interval: 10s
          unhealthy_threshold: 3
          healthy_threshold: 1
          http_health_check:
            path: "/"
            expected_statuses:
              - start: 200
                end: 399

    # 백엔드 클러스터 (내부망 포트 18443)
    # ⚠️ 중요: 프론트엔드 서버 IP 정보
    # - 내부망 IP: 10.0.0.10 (enp1s0) - 백엔드와 통신용
    # - 인터넷 IP: 14.54.57.159 (enp3s0) - 외부 사용자 접근용
    # ⚠️ 중요: 백엔드 서버 IP 정보
    # - 인터넷 IP: 61.73.245.105 (eth0) - 외부 접근용 (프론트엔드가 프록시하므로 직접 사용 안 함)
    # - 내부망 IP: 10.0.0.100 (eth1) - 주요 내부망 IP, 프론트엔드와 통신용
    # - 내부망 IP: 10.0.0.110 (eth0) - 추가 내부망 IP
    # - 리스닝: 0.0.0.0:18443 (모든 인터페이스)
    # ⚠️ 중요: 모든 세션 통신은 내부망 포트(18443)를 사용해야 함
    # - 외부 포트: 인터넷 접근용 (사용하지 않음)
    # - 내부망 포트: 프론트엔드-백엔드 통신용 (18443)
    # - 프론트엔드는 10.0.0.10 → 10.0.0.100:18443로 내부망 통신
    - name: backend_cluster
      connect_timeout: 5s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: backend_cluster
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: 10.0.0.100  # 내부망 IP
                      port_value: 18443  # 내부망 포트
      health_checks:
        - timeout: 1s
          interval: 10s
          unhealthy_threshold: 3
          healthy_threshold: 1
          http_health_check:
            path: "/api/health"
            expected_statuses:
              - start: 200
                end: 399

    # Agent 클러스터 (내부망 포트 9000)
    # ⚠️ 중요: 프론트엔드 서버 IP 정보
    # - 내부망 IP: 10.0.0.10 (enp1s0) - 백엔드와 통신용
    # - 인터넷 IP: 14.54.57.159 (enp3s0) - 외부 사용자 접근용
    # ⚠️ 중요: 백엔드 서버 IP 정보
    # - 인터넷 IP: 61.73.245.105 (eth0) - 외부 접근용 (프론트엔드가 프록시하므로 직접 사용 안 함)
    # - 내부망 IP: 10.0.0.100 (eth1) - 주요 내부망 IP, 프론트엔드와 통신용
    # - 내부망 IP: 10.0.0.110 (eth0) - 추가 내부망 IP
    # ⚠️ 중요: Agent 통신도 내부망 포트(9000)를 사용해야 함
    # - 프론트엔드는 10.0.0.10 → 10.0.0.100:9000로 내부망 통신
    - name: agent_cluster
      connect_timeout: 5s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: agent_cluster
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: 10.0.0.100  # 내부망 IP
                      port_value: 9000    # 내부망 포트
      health_checks:
        - timeout: 1s
          interval: 10s
          unhealthy_threshold: 3
          healthy_threshold: 1
          http_health_check:
            path: "/health"
            expected_statuses:
              - start: 200
                end: 399

# 관리 인터페이스
admin:
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 9901
